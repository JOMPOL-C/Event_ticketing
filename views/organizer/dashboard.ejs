<%- include('../includes/head') %>
</head>
<body class="bg-zinc-50">
  <%- include('../includes/nav') %>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-semibold text-zinc-800">แดชบอร์ดผู้จัดงาน</h1>
        <p class="text-sm text-zinc-500">ภาพรวมยอดขายและผู้ซื้อสำหรับอีเวนต์ของคุณ</p>
      </div>
      <a href="/api/events/new" class="inline-flex items-center rounded-xl px-4 py-2 text-white bg-indigo-600 hover:bg-indigo-700">
        + สร้างอีเวนต์ใหม่
      </a>
    </header>

    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="rounded-2xl border border-zinc-200 bg-white p-5">
        <div class="text-sm text-zinc-500">จำนวนอีเวนต์</div>
        <div class="mt-1 text-2xl font-semibold text-zinc-900"><%= (stats && stats.totalEvents) || 0 %></div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white p-5">
        <div class="text-sm text-zinc-500">คำสั่งซื้อ (ออเดอร์)</div>
        <div class="mt-1 text-2xl font-semibold text-zinc-900"><%= (stats && stats.totalOrders) || 0 %></div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white p-5">
        <div class="text-sm text-zinc-500">บัตรที่ขายได้</div>
        <div class="mt-1 text-2xl font-semibold text-zinc-900"><%= (stats && stats.totalTickets) || 0 %></div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white p-5">
        <div class="text-sm text-zinc-500">รายได้รวม (THB)</div>
        <div class="mt-1 text-2xl font-semibold text-zinc-900"><%= ((stats && stats.totalRevenue) || 0).toLocaleString('th-TH') %></div>
      </div>
    </section>

    <!-- Events table -->
    <section class="rounded-2xl border border-zinc-200 bg-white overflow-hidden">
      <div class="p-5 border-b border-zinc-200">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-lg font-semibold text-zinc-800">อีเวนต์ของฉัน</h2>
          <form class="flex items-center gap-2" method="get" action="/api/events">
            <input name="q" type="text" placeholder="ค้นหาชื่ออีเวนต์..." class="rounded-xl border border-zinc-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button type="submit" class="rounded-xl px-3 py-2 text-sm bg-zinc-900 text-white hover:bg-zinc-800">ค้นหา</button>
          </form>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-zinc-50 text-zinc-600">
            <tr>
              <th class="text-left font-medium px-5 py-3">อีเวนต์</th>
              <th class="text-left font-medium px-5 py-3">วันเวลาเริ่ม</th>
              <th class="text-right font-medium px-5 py-3">ราคา (THB)</th>
              <th class="text-right font-medium px-5 py-3">ขายแล้ว / ทั้งหมด</th>
              <th class="text-right font-medium px-5 py-3">รายได้</th>
              <th class="text-right font-medium px-5 py-3">การจัดการ</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-zinc-200">
            <% if (!events || events.length === 0) { %>
              <tr>
                <td colspan="6" class="px-5 py-6 text-center text-zinc-500">ยังไม่มีอีเวนต์</td>
              </tr>
            <% } %>

            <% (events || []).forEach(function(ev, idx){ %>
              <tr class="hover:bg-zinc-50">
                <td class="px-5 py-4">
                  <div class="flex items-center gap-3">
                    <% if (ev.coverImage) { %>
                      <img src="<%= ev.coverImage %>" alt="" class="h-10 w-16 object-cover rounded-md border border-zinc-200">
                    <% } %>
                    <div>
                      <div class="font-medium text-zinc-900"><a href="/api/events/<%= ev._id %>" class="hover:underline"><%= ev.title %></a></div>
                      <div class="text-xs text-zinc-500">คงเหลือ <%= Math.max(0, (ev.remainingTickets ?? 0)) %> ใบ</div>
                    </div>
                  </div>
                </td>
                <td class="px-5 py-4 text-zinc-700"><%= ev.startAt ? new Date(ev.startAt).toLocaleString('th-TH') : '-' %></td>
                <td class="px-5 py-4 text-right"><%= Number(ev.price || 0).toLocaleString('th-TH') %></td>
                <td class="px-5 py-4 text-right">
                  <%= (ev.metrics && ev.metrics.sold) || 0 %> / <%= ev.totalTickets || 0 %>
                </td>
                <td class="px-5 py-4 text-right font-medium text-zinc-900">
                  <%= ((ev.metrics && ev.metrics.revenue) || 0).toLocaleString('th-TH') %>
                </td>
                <td class="px-5 py-4 text-right">
                  <div class="inline-flex gap-2">
                    <a href="/api/events/<%= ev._id %>/edit" class="px-3 py-1.5 rounded-lg border border-zinc-300 hover:bg-zinc-100">แก้ไข</a>
                    <form action="/api/events/<%= ev._id %>?_method=DELETE" method="post" onsubmit="return confirm('ลบอีเวนต์นี้?');">
                      <button type="submit" class="px-3 py-1.5 rounded-lg border border-red-300 text-red-600 hover:bg-red-50">ลบ</button>
                    </form>
                    <button type="button" class="px-3 py-1.5 rounded-lg border border-zinc-300 hover:bg-zinc-100"
                            data-toggle="buyers" data-target="#buyers-<%= idx %>">
                      ผู้ซื้อ
                    </button>
                  </div>
                </td>
              </tr>

              <!-- Buyers list (collapsible) -->
              <tr id="buyers-<%= idx %>" class="hidden bg-zinc-50/70">
                <td colspan="6" class="px-5 py-4">
                  <div class="flex items-center justify-between mb-2">
                    <div class="text-sm text-zinc-600">
                      ออเดอร์: <span class="font-medium text-zinc-900"><%= (ev.metrics && ev.metrics.orders) || 0 %></span>
                      · ผู้ซื้อทั้งหมด: <span class="font-medium text-zinc-900"><%= (ev.buyers && ev.buyers.length) || 0 %></span>
                    </div>
                    <!-- (ออปชัน) ปุ่ม export CSV -->
                    <!-- <a href="/api/organizer/export?eventId=<%= ev._id %>" class="text-sm text-indigo-600 hover:underline">Export CSV</a> -->
                  </div>

                  <div class="overflow-x-auto">
                    <table class="min-w-full text-xs">
                      <thead>
                        <tr class="text-zinc-600">
                          <th class="text-left font-medium px-3 py-2">ผู้ซื้อ</th>
                          <th class="text-left font-medium px-3 py-2">อีเมล</th>
                          <th class="text-right font-medium px-3 py-2">จำนวนบัตร</th>
                          <th class="text-right font-medium px-3 py-2">ยอดชำระ (THB)</th>
                          <th class="text-left font-medium px-3 py-2">ชำระเมื่อ</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-zinc-200">
                        <% if (!ev.buyers || ev.buyers.length === 0) { %>
                          <tr>
                            <td colspan="5" class="px-3 py-4 text-center text-zinc-500">ยังไม่มีผู้ซื้อ</td>
                          </tr>
                        <% } %>
                        <% (ev.buyers || []).forEach(function(b){ %>
                          <tr>
                            <td class="px-3 py-2"><%= b.username || '-' %></td>
                            <td class="px-3 py-2"><%= b.email || '-' %></td>
                            <td class="px-3 py-2 text-right"><%= b.qty || 0 %></td>
                            <td class="px-3 py-2 text-right"><%= Number(b.amount || 0).toLocaleString('th-TH') %></td>
                            <td class="px-3 py-2"><%= b.paidAt ? new Date(b.paidAt).toLocaleString('th-TH') : '-' %></td>
                          </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // toggle buyers sections
    document.querySelectorAll('[data-toggle="buyers"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = document.querySelector(btn.dataset.target);
        if (!target) return;
        target.classList.toggle('hidden');
      });
    });
  </script>

  <%- include('../includes/footer') %>
</body>
</html>
